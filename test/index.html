<script src="../dist/ServerWorker.js"></script>
<script>
function test(ServerWorker, name){
  var iworker = new ServerWorker(function(emitter, math){
    // inline worker space
    emitter.on("hello", function(data, reply){
      reply("hello"+data+math.PI);
    });
  }, {PI:3.14});
  iworker.load().then(function(){
    console.log(name, "loaded");
    iworker.request("hello", name).then(function(data){
      console.log(name, data); // -> helloworker | helloiframe
      iworker.unload();
    });
  }).catch(function(err){ console.error(err, err.stack)});
}

function test2(ServerWorker, name){
  var iworker = new ServerWorker([], function(emitter){
    // inline worker space
    emitter.on("hello", function(data, reply){
      reply("hello"+data);
    });
  });
  iworker.load().then(function(){
    console.log(name, "loaded");
    iworker.request("hello", name).then(function(data){
      console.log(name, data); // -> helloworker | helloiframe
      iworker.unload();
    });
  }).catch(function(err){ console.error(err, err.stack)});
}


function test3(ServerWorker, name){
  var iworker = new ServerWorker(["./worker.js"], function(emitter){
    // inline worker space
    emitter.on("hello", function(data, reply){
      reply("hello"+add1(data));
    });
  });
  iworker.load().then(function(){
    console.log(name, "loaded");
    Promise.all(
      [1,2,3,4,5].map(function(i){
        return iworker.request("hello", name+i);
      })
    ).then(function(data){
      console.log(name, data); // -> helloworker | helloiframe
      iworker.unload();
    });
  }).catch(function(err){ console.error(err, err.stack)});
}

function test4(ServerWorker, name){
  var iworker = new ServerWorker(["./worker.js"], [function add2(x){return add1(add1(x));}], function(emitter){
    // inline worker space
    emitter.on("hello", function(data, reply){
      reply("hello"+add2(data));
    });
  });
  iworker.load().then(function(){
    console.log(name, "loaded");
    Promise.all(
      [1,2,3,4,5].map(function(i){
        return iworker.request("hello", name+i);
      })
    ).then(function(data){
      console.log(name, data); // -> helloworker | helloiframe
      iworker.unload();
    });
  }).catch(function(err){ console.error(err, err.stack)});
}


window.addEventListener("DOMContentLoaded", function(){
  test(InlineServerWorker, "worker1");
  test(IFrameServerWorker, "iframe1");
  test2(InlineServerWorker, "worker2");
  test2(IFrameServerWorker, "iframe2");
  test3(InlineServerWorker, "worker3");
  test3(IFrameServerWorker, "iframe3");
  test4(InlineServerWorker, "worker4");
  test4(IFrameServerWorker, "iframe4");
});
</script>
